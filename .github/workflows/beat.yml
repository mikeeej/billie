name: Auto Sync Worker

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 3 * * *" # æ¯å¤©å‡Œæ™¨3ç‚¹è¿è¡Œ
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  sync_worker:
    runs-on: ubuntu-latest
    steps:
      # æ£€å‡ºå½“å‰ä»“åº“
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      # åˆå§‹åŒ– .last_commit æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
      - name: åˆå§‹åŒ– .last_commit æ–‡ä»¶
        run: |
          if [ ! -f ".last_commit" ]; then
            echo "åˆå§‹åŒ– .last_commit æ–‡ä»¶"
            echo "" > .last_commit
            git add .last_commit
            git commit -m "ğŸ”„ åˆå§‹åŒ– .last_commit"
            git push
          fi

      # è·å–è¿œç¨‹æœ€æ–° commit
      - name: è·å–è¿œç¨‹ Worker æœ€æ–° commit
        id: get_latest_commit
        env:
          REPO_URL: "https://api.github.com/repos/yonggekkk/Cloudflare_vless_trojan"
        run: |
          log() { echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1"; }

          # è·å–æœ€æ–° commit hash
          log "è·å–è¿œç¨‹æœ€æ–° _worker.js commit..."
          LATEST_COMMIT=$(curl -s --retry 3 "$REPO_URL/commits?path=Vless_workers_pages/_worker.js&per_page=1" | jq -r '.[0].sha' || echo "error")
          
          if [ "$LATEST_COMMIT" = "error" ]; then
            log "ERROR: æ— æ³•è·å–è¿œç¨‹ commit ä¿¡æ¯"
            exit 1
          fi

          echo "LATEST_COMMIT=$LATEST_COMMIT" >> $GITHUB_ENV
          log "æœ€æ–° commit: $LATEST_COMMIT"

      # è¯»å–ä¸Šæ¬¡åŒæ­¥çš„ commit
      - name: è¯»å–ä¸Šæ¬¡åŒæ­¥çš„ commit
        id: read_last_commit
        run: |
          LAST_COMMIT=$(cat .last_commit)
          echo "LAST_COMMIT=$LAST_COMMIT" >> $GITHUB_ENV
          echo "ä¸Šæ¬¡åŒæ­¥çš„ commit: $LAST_COMMIT"

      # åŒæ­¥æ–‡ä»¶
      - name: åŒæ­¥ Worker æ–‡ä»¶
        if: env.LATEST_COMMIT != env.LAST_COMMIT
        run: |
          log() { echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1"; }

          # ä¸‹è½½æœ€æ–°çš„ _worker.js
          log "å¼€å§‹ä¸‹è½½ _worker.js..."
          curl -f -s --retry 3 -o _worker.js https://raw.githubusercontent.com/yonggekkk/Cloudflare_vless_trojan/main/Vless_workers_pages/_worker.js || { 
            log "ERROR: ä¸‹è½½ _worker.js å¤±è´¥"; 
            exit 1; 
          }
          
          # è®°å½•æœ€æ–°çš„ commit
          echo "$LATEST_COMMIT" > .last_commit
          log "ä¸‹è½½å®Œæˆï¼Œè®°å½•æœ€æ–° commit: $LATEST_COMMIT"

      # æäº¤å¹¶æ¨é€æ›´æ”¹
      - name: æäº¤å¹¶æ¨é€æ›´æ”¹
        if: env.LATEST_COMMIT != env.LAST_COMMIT
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ”„ è‡ªåŠ¨åŒæ­¥ _worker.js (Commit: ${{ env.LATEST_COMMIT }})"
          commit_author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
          file_pattern: |
            _worker.js
            .last_commit

      # æ— éœ€åŒæ­¥æ—¶è¾“å‡ºæç¤º
      - name: æ— éœ€åŒæ­¥æç¤º
        if: env.LATEST_COMMIT == env.LAST_COMMIT
        run: |
          echo "å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€åŒæ­¥ã€‚"
