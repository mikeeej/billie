name: Auto Sync Worker

on:
  schedule:
    - cron: "0 19 * * *"  # æ¯å¤©å‡Œæ™¨3ç‚¹è¿è¡Œ
  workflow_dispatch:      # æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main            # ç›‘å¬ main åˆ†æ”¯æ¨é€äº‹ä»¶

permissions:
  contents: write

jobs:
  sync_worker:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: æ£€æŸ¥ä¸Šæ¬¡åŒæ­¥çŠ¶æ€
        id: check_last_commit
        run: |
          if [ -f "last_commit.txt" ]; then
            LAST_COMMIT=$(cat last_commit.txt)
            echo "æ‰¾åˆ°ä¸Šæ¬¡åŒæ­¥çš„ commit: $LAST_COMMIT"
          else
            echo "æœªæ‰¾åˆ° last_commit.txt æ–‡ä»¶ï¼Œå¯èƒ½æ˜¯ç¬¬ä¸€æ¬¡è¿è¡Œ"
            LAST_COMMIT=""
          fi
          echo "LAST_COMMIT=$LAST_COMMIT" >> $GITHUB_ENV

      - name: è·å–è¿œç¨‹ Worker æœ€æ–° commit
        id: get_latest_commit
        env:
          REPO_URL: "https://api.github.com/repos/yonggekkk/Cloudflare_vless_trojan"
        run: |
          log() { echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1"; }
          log "è·å–è¿œç¨‹æœ€æ–° _worker.js commit..."
          LATEST_COMMIT=$(curl -s --retry 3 "$REPO_URL/commits?path=Vless_workers_pages/_worker.js&per_page=1" | jq -r '.[0].sha' || echo "error")
          if [ "$LATEST_COMMIT" = "error" ]; then
            log "ERROR: æ— æ³•è·å–è¿œç¨‹ commit ä¿¡æ¯"
            exit 1
          fi
          echo "LATEST_COMMIT=$LATEST_COMMIT" >> $GITHUB_ENV
          log "æœ€æ–° commit: $LATEST_COMMIT"

      - name: åŒæ­¥ Worker æ–‡ä»¶
        if: env.LAST_COMMIT != env.LATEST_COMMIT
        run: |
          log() { echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1"; }
          log "å¼€å§‹ä¸‹è½½ _worker.js..."
          curl -f -s --retry 3 -o _worker.js https://raw.githubusercontent.com/yonggekkk/Cloudflare_vless_trojan/main/Vless_workers_pages/_worker.js || {
            log "ERROR: ä¸‹è½½ _worker.js å¤±è´¥"
            exit 1
          }
          echo "$LATEST_COMMIT" > last_commit.txt
          log "ä¸‹è½½å®Œæˆï¼Œè®°å½•æœ€æ–° commit: $LATEST_COMMIT"

      - name: æäº¤å¹¶æ¨é€æ›´æ”¹
        if: env.LAST_COMMIT != env.LATEST_COMMIT
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ”„ è‡ªåŠ¨åŒæ­¥ _worker.js (Commit: ${{ env.LATEST_COMMIT }})"
          commit_author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"

      - name: æ— éœ€åŒæ­¥æç¤º
        if: env.LAST_COMMIT == env.LATEST_COMMIT
        run: echo "å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€åŒæ­¥ã€‚"
